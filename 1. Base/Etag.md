# Etag 七牛哈希算法

## Etag

| 名称   | 类型      | 类型                                 |
| ------ | --------- | ------------------------------------ |
| buffer | [uint8]   | AccessKey，必须存在                  |
| sha1s  | [[uint8]] | 已经计算出的 SHA1 结果集合，私有变量 |

### 支持接口

#### write()

接受输入的二进制数据

##### 接受参数

| 名称       | 类型       | 描述                              |
| ---------- | ---------- | --------------------------------- |
| data | [uint8] | 二进制数据 |

##### 返回参数

无

##### 伪代码实现

```
buffer.append(data)
while buffer.len() > 1<<22 {
	sha1s.append(sha1(buffer.get(0, 1<<22)))
	buffer.remove(0, 1<<22)
}
```

#### result()

计算 Etag 结果

##### 接受参数

无

##### 返回参数

| 名称       | 类型       | 类型                              |
| ---------- | ---------- | --------------------------------- |
| etag | String | 计算结果 |

##### 伪代码实现

```
if buffer {
	sha1s.append(sha1(buffer))
	buffer.clear()
}
switch sha1s.len() {
case 0:
	"Fto5o-5ea0sNMlW_75VgGJCv2AcJ"
case 1:
	buf = [0x16]
	buf.append(sha1s.get(0))
	urlsafe_base64_encode(buf)
default:
	buf = [0x96]
	buf.append(sha1(sha1s.join()))
	urlsafe_base64_encode(buf)
}
```

## EtagReader

实现输入流接口，可以用于封装并替换其他输入流接口

| 名称   | 类型      | 描述                                 |
| ------ | --------- | ------------------------------------ |
| reader | Reader   | 输入流接口，必须存在                  |
| etag  | Etag | Etag 计算器 |

### 支持接口

#### read()

模拟输入流接口

##### 接受参数

| 名称       | 类型       | 描述                              |
| ---------- | ---------- | --------------------------------- |
| len | uint64 | 读取的数据尺寸 |

##### 返回参数

| 名称       | 类型       | 描述                              |
| ---------- | ---------- | --------------------------------- |
| data | [uint8] | 读到的二进制数据 |

##### 伪代码实现

```
data = reader.read(len)
etag.write(data)
data
```

#### result()

计算 Etag 结果

##### 接受参数

无

##### 返回参数

| 名称       | 类型       | 类型                              |
| ---------- | ---------- | --------------------------------- |
| etag | String | 计算结果 |

##### 伪代码实现

```
etag.result()
```

## EtagUtils

辅助方法，简化 Etag 使用，也可以以 Etag 的类方法的形态实现

### 支持接口

#### from_reader()

计算指定的输入流的 Etag

##### 接受参数

| 名称       | 类型       | 描述                              |
| ---------- | ---------- | --------------------------------- |
| reader | Reader | 阅读器接口 |

##### 返回参数

| 名称       | 类型       | 描述                              |
| ---------- | ---------- | --------------------------------- |
| etag | String | 计算结果 |

##### 伪代码实现

```
reader = EtagReader(reader)
while (reader.read(1<<22).len() > 0) {
  // until got EOF
}
reader.result()
```

#### from_path()

计算指定的文件的 Etag

##### 接受参数

| 名称       | 类型       | 描述                              |
| ---------- | ---------- | --------------------------------- |
| path | Path | 文件路径 |

##### 返回参数

| 名称       | 类型       | 描述                              |
| ---------- | ---------- | --------------------------------- |
| etag | String | 计算结果 |

##### 伪代码实现

```
from_reader(open_file(path))
```